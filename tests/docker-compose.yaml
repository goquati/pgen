x-postgres-common: &postgres-common
  environment:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
  healthcheck:
    test: [ "CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}" ]
    interval: 1s
    timeout: 1s
    retries: 30
    start_period: 2s

services:
  jdbc-base:
    image: postgres:17.2
    <<: *postgres-common
    ports:
      - "55030:5432"
    profiles: [ jdbc-base ]
  jdbc-base-vector:
    image: pgvector/pgvector:0.8.0-pg17
    <<: *postgres-common
    ports:
      - "55031:5432"
    profiles: [ jdbc-base ]
  jdbc-wal:
    <<: *postgres-common
    ports:
      - "55032:5432"
    profiles: [ jdbc-wal ]
    command: ["postgres", "-c", "wal_level=logical"]
    build:
      dockerfile_inline: |
        FROM postgres:17.2
        RUN apt-get update \
          && apt-get install -y postgresql-17-wal2json \
          && apt-get clean \
          && rm -rf /var/lib/apt/lists/*
  r2dbc-base:
    image: postgres:17.2
    <<: *postgres-common
    ports:
      - "55130:5432"
    profiles: [ r2dbc-base ]
  r2dbc-base-vector:
    image: pgvector/pgvector:0.8.0-pg17
    <<: *postgres-common
    ports:
      - "55131:5432"
    profiles: [ r2dbc-base ]
  r2dbc-wal:
    <<: *postgres-common
    ports:
      - "55132:5432"
    profiles: [ r2dbc-wal ]
    command: ["postgres", "-c", "wal_level=logical"]
    build:
      dockerfile_inline: |
        FROM postgres:17.2
        RUN apt-get update \
          && apt-get install -y postgresql-17-wal2json \
          && apt-get clean \
          && rm -rf /var/lib/apt/lists/*